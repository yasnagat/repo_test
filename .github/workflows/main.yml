name: Interaction Limits Settings Management

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 27 3,7,11 *'  

jobs:
  interaction-mgmt:
    runs-on: ubuntu-latest

    env:
      GITHUB_URL: https://api.github.com/user/interaction-limits
      
    steps:
      - uses: actions/checkout@v4
       
      - name: Check the interaction limits setting
        id: check
        run: |
          set -euo pipefail
          curl -s \
            -H "Authorization: Bearer ${{ secrets.PERSONAL_TOKEN }}" \
            "${GITHUB_URL}" \
            -o response.json
          
      - name: Manage limits
        id: manage
        run: |
          set -euo pipefail
          
          if jq -e '. == {}' response.json; then
            http_code=$(
              curl -s -w "%{http_code}" -o response.json \
                -H "Authorization: Bearer ${{ secrets.PERSONAL_TOKEN }}" \
                -X PUT \
                "${GITHUB_URL}" \
                -d '{"limit":"existing_users","expiry":"six_months"}'
            )

            if [ "$http_code" -eq 200 ]; then
              result="Limits enabled."
              echo "$result"
              echo "action=enabled" >> $GITHUB_OUTPUT
            else
              echo "Failed with HTTP $http_code"
              exit 1
            fi

          elif jq -e 'has("limit")' response.json; then
            result="Limits already active."
            echo "$result"
            cat response.json
            echo "action=active" >> $GITHUB_OUTPUT
          fi 

      - name: Exhibit errors
        if: failure()
        run: |
          set -euo pipefail
          [ -f response.json ] || exit 0
          jq -e 'has("message") and has("documentation_url")' response.json || exit 0
          result="An error occurred during the execution. Details:"
          echo "$result"
          cat response.json

      - name: Send report to webhook
        if: always()
        env:
          WEBHOOK_URL: https://teeniest-felisha-diuretically.ngrok-free.dev/hooks/6939b73ee0bb71992508c38b/WjvoH8fFnoj5mwkFRvWEbt5mqJ7v53afpJoM8b2HZwLeDQgv
        run: |
          set -euo pipefail

          # Recupera o resultado da step "manage"
          ACTION="${{ steps.manage.outputs.action }}"

          # Se por algum motivo não houver output, define um padrão
          if [ -z "$ACTION" ]; then
            ACTION="not_set"
          fi

          # Monta o texto que você quer enviar, mas mantendo a estrutura exigida:
          # {"alias":"Admin","text":"...","attachments":[{...}]}
          TEXT="Resultado da automação de Interaction Limits: ${ACTION}"

          # Gera o JSON exatamente com os campos esperados
          # Estrutura final:
          # {"alias":"Admin","text":"<TEXT>","attachments":[{}]}
          payload=$(jq -n --arg alias "Admin" --arg text "$TEXT" '
            {
              alias: $alias,
              text: $text,
              attachments: [ {} ]
            }
          ')

          echo "Payload enviado:"
          echo "$payload"

          curl -sS -w "\nHTTP_CODE:%{http_code}\n" \
            -X POST "${WEBHOOK_URL}" \
            -H 'Content-Type: application/json' \
            --data "$payload"
