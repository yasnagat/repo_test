name: Interaction Limits Settings Management

on:
  workflow_dispatch:

jobs:
  interaction-mgmt:
    runs-on: ubuntu-latest

    env:
      GITHUB_URL: https://api.github.com/user/interaction-limits

    steps:
      - uses: actions/checkout@v4

      - name: Check the interaction limits setting
        id: check
        run: |
          set -euo pipefail

          # Inicia o relatÃ³rio zerado
          : > report.log

          echo "Checking interaction limits setting..." | tee -a report.log

          curl -s \
            -H "Authorization: Bearer ${{ secrets.PERSONAL_TOKEN }}" \
            "${GITHUB_URL}" \
            -o response.json

          echo "Initial API response:" | tee -a report.log
          cat response.json | tee -a report.log

      - name: Manage limits
        id: manage
        run: |
          set -euo pipefail

          if jq -e '. == {}' response.json; then
            http_code=$(
              curl -s -w "%{http_code}" -o response.json \
                -H "Authorization: Bearer ${{ secrets.PERSONAL_TOKEN }}" \
                -X PUT \
                "${GITHUB_URL}" \
                -d '{"limit":"existing_users","expiry":"six_months"}'
            )

            if [ "$http_code" -eq 200 ]; then
              result="Limits enabled."
              echo "$result" | tee -a report.log
              echo "HTTP code: $http_code" | tee -a report.log
              echo "Updated API response:" | tee -a report.log
              cat response.json | tee -a report.log
              echo "action=enabled" >> "$GITHUB_OUTPUT"
            else
              result="Failed with HTTP $http_code"
              echo "$result" | tee -a report.log
              echo "API response on failure:" | tee -a report.log
              cat response.json | tee -a report.log
              exit 1
            fi

          elif jq -e 'has("limit")' response.json; then
            result="Limits already active."
            echo "$result" | tee -a report.log
            cat response.json | tee -a report.log
            echo "action=active" >> "$GITHUB_OUTPUT"
          fi

      - name: Exhibit errors
        if: failure()
        run: |
          set -euo pipefail

          if [ -f response.json ]; then
            if jq -e 'has("message") and has("documentation_url")' response.json; then
              result="An error occurred during execution. Details:"
              echo "$result" | tee -a report.log
              cat response.json | tee -a report.log
            fi
          fi

      - name: Send report to webhook
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        run: |
          set -euo pipefail

          LOGS=$(sed 's/"/\\"/g' report.log)

          payload="{\"alias\":\"Security Notifications\",\"text\":\"**GitHub User Limit Interaction Setting - ($GITHUB_REPOSITORY)**\n\n$LOGS\"}"

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            --data "$payload"
