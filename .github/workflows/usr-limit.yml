name: Interaction Limits Settings Management

on:
  workflow_dispatch:

jobs:
  interaction-mgmt:
    runs-on: ubuntu-latest

    env:
      GITHUB_URL: https://api.github.com/user/interaction-limits

    steps:
      - uses: actions/checkout@v4

      - name: Check the interaction limits setting
        id: check
        run: |
          set -euo pipefail

          curl -s \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.MY_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${GITHUB_URL}" \
            -o response.json

      - name: Manage limits
        id: manage
        run: |
          set -euo pipefail

          if jq -e '. == {}' response.json; then
            http_code=$(
              curl -s -w "%{http_code}" -o response.json \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.MY_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                -X PUT \
                "${GITHUB_URL}" \
                -d '{"limit":"existing_users","expiry":"six_months"}'
            )

            if [ "$http_code" -eq 200 ]; then
              echo "result=Limits enabled now." >> "$GITHUB_OUTPUT"
            else
              echo "result=Failed with HTTP $http_code" >> "$GITHUB_OUTPUT"
              exit 1
            fi

          elif jq -e 'has("limit")' response.json; then
            echo "result=Limits already active. Expires at: $(jq -r '.expires_at // empty' response.json)" >> "$GITHUB_OUTPUT"
          fi

      - name: Exhibit errors
        id: errors
        if: failure()
        run: |
          set -euo pipefail

          [ -f response.json ] || exit 0

          if jq -e 'has("message") and has("documentation_url")' response.json > /dev/null; then
            echo "result=An error occurred during the execution. Message: $(jq -r '.message' response.json). Docs: $(jq -r '.documentation_url' response.json)" >> "$GITHUB_OUTPUT"
          else
            echo "result=An error occurred during the execution, but response.json has no standard error fields." >> "$GITHUB_OUTPUT"
          fi

      - name: Send report to webhook
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          RESULT_MANAGE: ${{ steps.manage.outputs.result }}
          RESULT_ERRORS: ${{ steps.errors.outputs.result }}
        run: |
          # sem -u aqui para não quebrar se alguma variável vier vazia
          set -eo pipefail

          echo "DEBUG - RESULT_MANAGE: '${RESULT_MANAGE}'"
          echo "DEBUG - RESULT_ERRORS: '${RESULT_ERRORS}'"

          text="**User Limit Interaction**"

          if [ -n "${RESULT_MANAGE:-}" ]; then
            text="$text\n\n${RESULT_MANAGE}"
          fi

          if [ -n "${RESULT_ERRORS:-}" ]; then
            text="$text\n\n${RESULT_ERRORS}"
          fi

          payload=$(jq -n \
            --arg alias "Security Notifications" \
            --arg text "$text" \
            '{alias: $alias, text: $text}')

          echo "Payload being sent to webhook:"
          echo "$payload"

          curl -sS -w "\nHTTP_CODE:%{http_code}\n" \
            -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            --data "$payload"
